<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        /* CSS code (same as before) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #f5f7fb; min-height: 100vh;
        }
        .header { 
            background: #2c3e50; color: white; padding: 20px 30px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .nav { 
            background: white; padding: 15px 30px; border-bottom: 1px solid #eaeaea;
            display: flex; gap: 10px;
        }
        .nav-btn { 
            background: white; border: 2px solid #667eea; color: #667eea; 
            padding: 10px 20px; border-radius: 25px; cursor: pointer;
            transition: all 0.3s; font-weight: 600;
        }
        .nav-btn:hover, .nav-btn.active { 
            background: #667eea; color: white; 
        }
        .container { padding: 30px; max-width: 1200px; margin: 0 auto; }
        .card { 
            background: white; padding: 30px; border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.08); margin-bottom: 25px;
            border: 1px solid #f0f0f0;
        }
        .form-group { margin-bottom: 20px; }
        label { 
            display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;
            font-size: 14px;
        }
        input, select, textarea { 
            width: 100%; padding: 12px 15px; border: 2px solid #e8e8e8; 
            border-radius: 8px; font-size: 14px; transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none; border-color: #667eea; 
        }
        .btn { 
            background: #667eea; color: white; border: none; padding: 12px 25px; 
            border-radius: 8px; cursor: pointer; margin: 5px; 
            font-weight: 600; transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; }
        .btn-info { background: #17a2b8; }
        
        .link-item { 
            background: white; padding: 20px; border-radius: 10px; 
            margin-bottom: 15px; border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .secure-link { 
            background: #f8f9fa; padding: 12px; border-radius: 6px; 
            font-family: 'Courier New', monospace; word-break: break-all; 
            margin: 8px 0; border: 1px solid #e9ecef; font-size: 14px;
        }
        
        .link-actions { 
            display: flex; gap: 8px; margin-top: 15px; flex-wrap: wrap;
        }
        
        .stats { display: flex; gap: 20px; margin-bottom: 30px; }
        .stat-card { 
            background: white; padding: 20px; border-radius: 10px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); flex: 1; text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; color: #667eea; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        
        .message { 
            padding: 15px; border-radius: 8px; margin: 15px 0; 
            text-align: center; display: none;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .grid-2, .grid-4 { grid-template-columns: 1fr; }
            .nav { padding: 0 15px; flex-wrap: wrap; }
            .header { padding: 15px 20px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîó Professional Dashboard</h1>
        <div class="user-info">
            <div style="color: #bdc3c7;" id="userBadge">Loading...</div>
            <button class="btn btn-danger" onclick="logout()">üö™ Logout</button>
        </div>
    </div>
    
    <div class="nav">
        <button class="nav-btn active" onclick="showSection('dashboard', this)">üìä Dashboard</button>
        <button class="nav-btn" onclick="showSection('links', this)">üîó Manage Links</button>
        <button class="nav-btn" onclick="showSection('create', this)">‚ûï Create Link</button>
    </div>
    
    <div class="container">
        <div id="dashboardSection" class="section">
            <div class="stats grid-4">
                <div class="stat-card">
                    <div class="stat-number" id="totalLinks">0</div>
                    <div class="stat-label">Total Links</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeLinks">0</div>
                    <div class="stat-label">Active Links</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="protectedLinks">0</div>
                    <div class="stat-label">Protected Links</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalClicks">0</div>
                    <div class="stat-label">Total Clicks</div>
                </div>
            </div>
            
            <div class="card">
                <h2>üìã Recent Links</h2>
                <div id="recentLinks">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">
                        Loading links...
                    </p>
                </div>
            </div>
        </div>

        <div id="createSection" class="section" style="display: none;">
            <div class="card">
                <h2>üîó Create New Permanent Link</h2>
                <div id="message"></div>
                <div class="grid-2">
                    <div class="form-group">
                        <label for="linkName">üìù Link Name *</label>
                        <input type="text" id="linkName" placeholder="e.g., Price Data API">
                    </div>
                    <div class="form-group">
                        <label for="customSlug">üîó Custom Slug *</label>
                        <input type="text" id="customSlug" placeholder="e.g., price-data">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="actualUrl">üåê Target URL *</label>
                    <input type="url" id="actualUrl" placeholder="https://example.com/data.json">
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="linkPassword">üîí Access Password</label>
                        <input type="text" id="linkPassword" placeholder="Optional security (only letters/numbers)">
                    </div>
                    <div class="form-group">
                        <label for="linkDescription">üìã Description</label>
                        <input type="text" id="linkDescription" placeholder="Brief description">
                    </div>
                </div>
                
                <button class="btn" onclick="addNewLink()">
                    üöÄ Create Permanent Link
                </button>
            </div>
        </div>

        <div id="linksSection" class="section" style="display: none;">
            <div class="card">
                <h2>üìÇ Your Permanent Links</h2>
                <div id="linksList">
                    <p style="text-align: center; color: #6c757d; padding: 40px;">
                        Loading links...
                    </p>
                </div>
            </div>
        </div>

        <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:100; justify-content:center; align-items:center;">
            <div class="card" style="max-width: 500px; width: 90%;">
                <h2>‚úèÔ∏è Edit Link</h2>
                <div class="form-group">
                    <label>Link Slug (Cannot be changed)</label>
                    <input type="text" id="editSlugDisplay" readonly>
                </div>
                <div class="form-group">
                    <label for="editLinkName">Link Name</label>
                    <input type="text" id="editLinkName">
                </div>
                <div class="form-group">
                    <label for="editActualUrl">Target URL</label>
                    <input type="url" id="editActualUrl">
                </div>
                <div class="form-group">
                    <label for="editLinkPassword">Access Password</label>
                    <input type="text" id="editLinkPassword">
                </div>
                <button class="btn btn-success" onclick="saveEditedLink()">Save Changes</button>
                <button class="btn btn-danger" onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- APNA NAYA WEB APP URL YAHAN DALA GAYA HAI ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbz8tt85GE9PRNeErgwGtLFM_WfdVrxPPGOsAfy77FLbhmQmlPHZZJ-Lhhqy_z4dKF3T4w/exec';
        let allLinksData = []; // Global store for link data

        // Authentication check
        const currentSession = JSON.parse(sessionStorage.getItem('adminSession'));
        if (!currentSession || !currentSession.loggedIn) {
            window.location.href = 'index.html';
        }

        // Display user info
        document.getElementById('userBadge').textContent = 
            `Welcome, ${currentSession.username} (${currentSession.role})`;

        // --- CORE FUNCTIONS ---

        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.style.display = 'block';
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }

        async function fetchLinks() {
            try {
                // Show loading state while fetching
                document.getElementById('linksList').innerHTML = '<p style="text-align: center; color: #667eea; padding: 40px;">Fetching links from Google Sheet...</p>';
                document.getElementById('recentLinks').innerHTML = '<p style="text-align: center; color: #667eea; padding: 40px;">Fetching recent links...</p>';
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'getLinks' })
                });
                const result = await response.json();
                
                if (result.success) {
                    allLinksData = result.data || [];
                    displayLinks();
                    updateStats();
                    displayRecentLinks();
                } else {
                    // If script returns success:false but message
                    allLinksData = [];
                    displayLinks(); // Clears lists
                    updateStats(); // Sets counts to 0
                    showMessage(`Error fetching links: ${result.message}`, 'error');
                }
            } catch (error) {
                // If network/CORS error occurs
                allLinksData = [];
                displayLinks(); // Clears lists
                updateStats(); // Sets counts to 0
                showMessage('Connection error: Could not connect to backend to fetch data.', 'error');
            }
        }

        async function addNewLink() {
            const name = document.getElementById('linkName').value;
            const customSlug = document.getElementById('customSlug').value.toLowerCase().replace(/[^a-z0-9-]/g, '');
            const url = document.getElementById('actualUrl').value;
            const password = document.getElementById('linkPassword').value;
            const description = document.getElementById('linkDescription').value;
            
            if (!name || !url || !customSlug) {
                showMessage('Please fill all required fields', 'error');
                return;
            }
            
            const linkBtn = document.querySelector('#createSection .btn');
            linkBtn.disabled = true;

            const linkData = {
                name: name,
                slug: customSlug,
                actualUrl: url,
                password: password,
                description: description,
                createdBy: currentSession.username
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'addLink', linkData: linkData })
                });
                const result = await response.json();

                if (result.message.includes('successfully')) {
                    showMessage('‚úÖ ' + result.message, 'success');
                    clearForm();
                    await fetchLinks(); // Refresh data
                    showSection('links', document.querySelector('.nav-btn:nth-child(2)'));
                } else {
                    showMessage('‚ùå ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Server connection error.', 'error');
            } finally {
                linkBtn.disabled = false;
            }
        }

        async function deleteLink(slug) {
            if (confirm('Are you sure you want to delete this link?')) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ action: 'deleteLink', slug: slug })
                    });
                    const result = await response.json();

                    if (result.message.includes('successfully')) {
                        showMessage('‚úÖ ' + result.message, 'success');
                        await fetchLinks(); // Refresh data
                    } else {
                        showMessage('‚ùå ' + result.message, 'error');
                    }
                } catch (error) {
                    showMessage('‚ùå Server connection error.', 'error');
                }
            }
        }
        
        // --- UI RENDERING & HELPERS ---
        
        function getPermanentUrl(slug, password) {
            // Permanent link now points to the Apps Script Web App
            let url = `${API_URL}?s=${slug}`;
            if (password) {
                // For secure links, the password is included in the URL for the Apps Script to validate
                url += `&p=${password}`;
            }
            return url;
        }

        function displayLinks() {
            const linksList = document.getElementById('linksList');
            if (allLinksData.length === 0) {
                linksList.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">No links created yet. Create your first permanent link!</p>';
                return;
            }

            let html = '';
            allLinksData.forEach(link => {
                const permanentUrl = getPermanentUrl(link.slug, link.password);
                const securityBadge = link.password ? 
                    '<span style="background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">üîê Protected</span>' : 
                    '<span style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">üîì Public</span>';
                
                html += `
                    <div class="link-item">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <strong style="font-size: 18px;">${link.name}</strong>
                                    ${securityBadge}
                                </div>
                                ${link.description ? `<p style="color: #666; margin-bottom: 10px;">${link.description}</p>` : ''}
                                <div style="font-size: 14px; color: #888;">
                                    üîó <strong>Slug:</strong> ${link.slug} | 
                                    üëÜ <strong>Clicks:</strong> ${link.clicks} | 
                                    üìÖ <strong>Created:</strong> ${new Date(link.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <strong>üéØ Target URL:</strong> 
                            <div style="color: #666; font-size: 14px; word-break: break-all; background: #f8f9fa; padding: 8px; border-radius: 5px; margin-top: 5px;">
                                ${link.target_url}
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <strong>üîó Permanent Link:</strong>
                            <div class="secure-link">${permanentUrl}</div>
                        </div>
                        
                        <div class="link-actions">
                            <button class="btn" onclick="copyToClipboard('${permanentUrl}')">
                                üìã Copy Link
                            </button>
                            <button class="btn btn-warning" onclick="openEditModal('${link.slug}')">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn btn-success" onclick="window.open('${permanentUrl}', '_blank')">
                                üß™ Test
                            </button>
                            <button class="btn btn-danger" onclick="deleteLink('${link.slug}')">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
            });

            linksList.innerHTML = html;
        }

        function displayRecentLinks() {
            const recentLinksDiv = document.getElementById('recentLinks');
            const linksArray = [...allLinksData]
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);

            if (linksArray.length === 0) {
                recentLinksDiv.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">No links created yet.</p>';
                return;
            }

            let html = '';
            linksArray.forEach(link => {
                const permanentUrl = getPermanentUrl(link.slug, link.password);
                html += `
                    <div style="padding: 15px; border-bottom: 1px solid #eee;">
                        <strong>${link.name}</strong>
                        <div style="color: #666; font-size: 13px;">${permanentUrl}</div>
                        <div style="color: #888; font-size: 12px;">Clicks: ${link.clicks} | Created: ${new Date(link.created_at).toLocaleDateString()}</div>
                    </div>
                `;
            });

            recentLinksDiv.innerHTML = html;
        }

        function updateStats() {
            const total = allLinksData.length;
            const active = allLinksData.filter(link => link.is_active).length;
            const protectedCount = allLinksData.filter(link => link.password).length;
            const totalClicks = allLinksData.reduce((sum, link) => sum + (link.clicks || 0), 0);
            
            document.getElementById('totalLinks').textContent = total;
            document.getElementById('activeLinks').textContent = active;
            document.getElementById('protectedLinks').textContent = protectedCount;
            document.getElementById('totalClicks').textContent = totalClicks;
        }
        
        function clearForm() {
            document.getElementById('linkName').value = '';
            document.getElementById('customSlug').value = '';
            document.getElementById('actualUrl').value = '';
            document.getElementById('linkPassword').value = '';
            document.getElementById('linkDescription').value = '';
        }

        function showSection(sectionName, element) {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionName + 'Section').style.display = 'block';
            element.classList.add('active');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showMessage('‚úÖ Link copied to clipboard!', 'success');
            });
        }
        
        function logout() {
            sessionStorage.removeItem('adminSession');
            window.location.href = 'index.html';
        }

        function openEditModal(slug) {
            alert("Editing is disabled in the current code for simplicity, as it requires complex row finding and updating in Google Sheets. You can manually edit the entry in the 'Links' sheet for now.");
        }
        
        // --- INITIALIZATION ---
        fetchLinks();
        // Set the default section to dashboard
        document.getElementById('dashboardSection').style.display = 'block';

    </script>
</body>
</html>
